name: Daily Risk Update

on:
  schedule:
    # Run daily at 6 PM UTC (after US market close at 4 PM EST / 1 PM PST)
    - cron: '0 18 * * *'
  workflow_dispatch:  # Allow manual trigger from GitHub Actions tab

jobs:
  update-risk-scores:
    runs-on: ubuntu-latest

    permissions:
      contents: write  # Need write permission to commit changes

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for proper git operations

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Create secrets.ini from GitHub Secret
        run: |
          mkdir -p config/credentials
          cat > config/credentials/secrets.ini << EOF
          [fred]
          api_key = ${{ secrets.FRED_API_KEY }}

          [email]
          # Email not needed for daily updates, only weekly reports
          from_email =
          smtp_server =
          smtp_port =
          smtp_username =
          smtp_password =
          EOF

      - name: Run daily update
        run: |
          echo "=========================================="
          echo "Running Aegis Daily Risk Update"
          echo "Date: $(date)"
          echo "=========================================="
          python scripts/daily_update.py

      - name: Copy updated CSVs to dashboard directory
        run: |
          mkdir -p dashboard/data
          cp data/history/risk_scores.csv dashboard/data/
          cp data/history/raw_indicators.csv dashboard/data/
          echo "CSV files copied to dashboard/data/"

      - name: Check for changes
        id: check_changes
        run: |
          git diff --quiet data/history/*.csv dashboard/data/*.csv || echo "has_changes=true" >> $GITHUB_OUTPUT

      - name: Commit and push changes
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git config user.name "Aegis Bot"
          git config user.email "aegis-bot@users.noreply.github.com"

          # Add updated CSV files
          git add data/history/risk_scores.csv
          git add data/history/raw_indicators.csv
          git add dashboard/data/risk_scores.csv
          git add dashboard/data/raw_indicators.csv

          # Create commit with current risk score
          RISK_SCORE=$(tail -1 data/history/risk_scores.csv | cut -d',' -f2)
          TIER=$(tail -1 data/history/risk_scores.csv | cut -d',' -f8)
          DATE=$(tail -1 data/history/risk_scores.csv | cut -d',' -f1)

          git commit -m "Daily risk update: ${DATE} - Risk ${RISK_SCORE}/10 (${TIER})" \
                     -m "Automated update from GitHub Actions workflow" \
                     -m "ðŸ¤– Generated by Aegis Bot"

          # Push changes
          git push

      - name: Summary
        if: always()
        run: |
          echo "=========================================="
          echo "Daily Update Summary"
          echo "=========================================="

          # Show latest risk score
          if [ -f data/history/risk_scores.csv ]; then
            LATEST=$(tail -1 data/history/risk_scores.csv)
            DATE=$(echo "$LATEST" | cut -d',' -f1)
            RISK=$(echo "$LATEST" | cut -d',' -f2)
            TIER=$(echo "$LATEST" | cut -d',' -f8)

            echo "Date: $DATE"
            echo "Risk Score: $RISK/10"
            echo "Tier: $TIER"
            echo ""

            # Dimension breakdown
            echo "Dimension Scores:"
            echo "  Recession: $(echo "$LATEST" | cut -d',' -f3)"
            echo "  Credit: $(echo "$LATEST" | cut -d',' -f4)"
            echo "  Valuation: $(echo "$LATEST" | cut -d',' -f5)"
            echo "  Liquidity: $(echo "$LATEST" | cut -d',' -f6)"
            echo "  Positioning: $(echo "$LATEST" | cut -d',' -f7)"
          fi

          echo "=========================================="
          echo "Dashboard will auto-update on Netlify"
          echo "=========================================="
