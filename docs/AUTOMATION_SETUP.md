# Automation Setup - GitHub Actions Daily Updates

This guide explains how to set up automated daily risk score updates using GitHub Actions.

## Overview

Once configured, Aegis will:
- **Run automatically every day at 6 PM UTC** (after US market close)
- Fetch latest economic indicators from FRED, Yahoo Finance, and Shiller
- Calculate current risk scores
- Update CSV files in `data/history/` and `dashboard/data/`
- Commit and push changes to GitHub
- **Trigger Netlify to redeploy the dashboard** (automatic)

**Result:** Your dashboard at https://aegis-risk.netlify.app will show today's risk score!

---

## Setup Instructions

### Step 1: Get Your FRED API Key

1. Go to https://fred.stlouisfed.org/
2. Create a free account (if you don't have one)
3. Navigate to: **My Account ‚Üí API Keys**
4. Click "Request API Key"
5. Copy your API key (looks like: `a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6`)

### Step 2: Add API Key to GitHub Secrets

1. Go to your GitHub repository: https://github.com/ducroq/Aegis
2. Click **Settings** (top right)
3. In the left sidebar, click **Secrets and variables ‚Üí Actions**
4. Click **New repository secret**
5. Enter:
   - **Name:** `FRED_API_KEY`
   - **Value:** Paste your FRED API key
6. Click **Add secret**

### Step 3: Enable GitHub Actions

1. Go to **Actions** tab in your GitHub repository
2. If GitHub Actions is disabled, click **Enable Actions**
3. You should see the "Daily Risk Update" workflow listed

### Step 4: Test the Workflow (Manual Trigger)

1. Go to **Actions** tab
2. Click on **Daily Risk Update** workflow (left sidebar)
3. Click **Run workflow** button (right side)
4. Click the green **Run workflow** button in the dropdown
5. Wait ~30 seconds for the workflow to complete

You should see:
- ‚úÖ Green checkmark = Success!
- A new commit in your repository with updated CSV files
- Netlify will automatically redeploy (takes 1-2 minutes)

---

## How It Works

### Workflow Schedule

The workflow runs daily at **6 PM UTC**:
- **US Eastern:** 1 PM (summer) / 2 PM (winter) - after market close
- **US Pacific:** 10 AM (summer) / 11 AM (winter)
- **Europe:** 6 PM - 8 PM depending on timezone

This timing ensures:
- ‚úÖ Market data from the day is available
- ‚úÖ FRED releases latest economic data
- ‚úÖ Risk scores reflect end-of-day conditions

### What Gets Updated

**Data Files:**
- `data/history/risk_scores.csv` - Appends new row with today's risk
- `data/history/raw_indicators.csv` - Appends raw indicator values
- `dashboard/data/*.csv` - Copies for Netlify deployment

**Commit Message Example:**
```
Daily risk update: 2025-01-14 - Risk 1.15/10 (GREEN)

Automated update from GitHub Actions workflow
ü§ñ Generated by Aegis Bot
```

### Dashboard Auto-Update

1. GitHub Actions commits new CSV files
2. GitHub webhook notifies Netlify
3. Netlify rebuilds and deploys dashboard (~1 minute)
4. Dashboard now shows latest risk score!

**Live URL:** https://aegis-risk.netlify.app

---

## Monitoring

### Check Workflow Status

1. Go to **Actions** tab
2. Recent runs are listed with status:
   - ‚úÖ **Success** - Risk scores updated
   - ‚ùå **Failed** - Check logs for errors
   - üü° **In Progress** - Currently running

### View Logs

1. Click on any workflow run
2. Click on the job name ("update-risk-scores")
3. Expand steps to see detailed logs
4. Look for "Daily Update Summary" at the bottom

### Common Issues

**Issue:** Workflow fails with "API key not found"
- **Fix:** Check that `FRED_API_KEY` secret is set correctly

**Issue:** Workflow fails with "403 Forbidden"
- **Fix:** Check repository Settings ‚Üí Actions ‚Üí Workflow permissions
- Enable "Read and write permissions"

**Issue:** No changes committed
- **Fix:** This is normal if FRED data hasn't updated since yesterday
- Risk scores only change when underlying data changes

**Issue:** Dashboard not updating
- **Fix:** Check Netlify deploy status at https://app.netlify.com
- Look for deploy triggered by GitHub push

---

## Manual Trigger

You can trigger the workflow manually anytime:

1. Go to **Actions** tab
2. Click **Daily Risk Update** workflow
3. Click **Run workflow** button
4. Select branch (usually `master`)
5. Click **Run workflow**

This is useful for:
- Testing after configuration changes
- Getting immediate update instead of waiting for scheduled run
- Recovering from a failed automated run

---

## Disabling Automation

To stop daily updates:

**Option 1: Disable the workflow**
1. Go to **Actions** tab
2. Click **Daily Risk Update** workflow
3. Click the **‚ãØ** (three dots) menu
4. Select "Disable workflow"

**Option 2: Delete the workflow file**
```bash
git rm .github/workflows/daily_update.yml
git commit -m "Disable daily automation"
git push
```

---

## Cost

**100% FREE!**

- GitHub Actions: 2,000 minutes/month free (each run uses ~1 minute)
- FRED API: Free (with 120,000 requests/day limit)
- Yahoo Finance: Free (public data)
- Netlify: Free tier includes automatic deploys

**Monthly usage:** ~30 minutes of GitHub Actions (well within free tier)

---

## Troubleshooting

### View Latest Risk Score

Check the most recent commit message:
```
Daily risk update: 2025-01-14 - Risk 1.15/10 (GREEN)
```

Or check the CSV file:
```bash
# View last line of risk_scores.csv on GitHub
tail -1 data/history/risk_scores.csv
```

### Test Locally

Run the same command GitHub Actions uses:
```bash
python scripts/daily_update.py
```

This helps debug issues before they affect automation.

### API Rate Limits

- **FRED:** 120,000 requests/day (we use ~35/day)
- **Yahoo Finance:** No official limit, but may throttle (script handles this)

If you hit rate limits:
- Wait 5 minutes and retry
- Check if multiple workflows are running simultaneously

---

## Next Steps

After automation is working:

1. **Monitor for 1 week** - Ensure daily updates run successfully
2. **Set up weekly email alerts** - See `docs/EMAIL_SETUP.md` (coming soon)
3. **Review dashboard daily** - Build habit of checking risk scores
4. **Adjust thresholds** - Tune YELLOW/RED levels based on your risk tolerance

---

## Security Notes

- ‚úÖ **FRED API key is stored securely** in GitHub Secrets (encrypted)
- ‚úÖ **Never committed to repository** (secrets.ini is gitignored)
- ‚úÖ **Only accessible to GitHub Actions** workflows
- ‚úÖ **Not visible in logs** (GitHub automatically redacts secrets)

**If you accidentally expose your API key:**
1. Go to FRED ‚Üí My Account ‚Üí API Keys
2. Delete the compromised key
3. Generate a new key
4. Update GitHub Secret with new key

---

## Support

- **GitHub Actions docs:** https://docs.github.com/actions
- **FRED API docs:** https://fred.stlouisfed.org/docs/api/
- **Aegis issues:** https://github.com/ducroq/Aegis/issues

---

**Last Updated:** 2025-01-13
**Status:** Ready for production use
